local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local activeButtons = {}

local function rippleEffect(object)
    object.MouseEnter:Connect(function()
        TweenService:Create(object, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(60, 60, 80)}):Play()
    end)
    object.MouseLeave:Connect(function()
        TweenService:Create(object, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(40, 40, 55)}):Play()
    end)
end

local function createUI()
    if playerGui:FindFirstChild("ProximityClickerUI") then
        playerGui:FindFirstChild("ProximityClickerUI"):Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ProximityClickerUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 380, 0, 500)
    mainFrame.Position = UDim2.new(0.5, -190, 0.5, -250)
    mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    mainFrame.BorderSizePixel = 0
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    
    local mainCorner = Instance.new("UICorner", mainFrame)
    mainCorner.CornerRadius = UDim.new(0, 15)
    
    local mainStroke = Instance.new("UIStroke", mainFrame)
    mainStroke.Color = Color3.fromRGB(80, 80, 255)
    mainStroke.Thickness = 2
    mainStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

    task.spawn(function()
        local t = 0
        while mainFrame.Parent do
            t = t + 0.02
            mainStroke.Color = Color3.fromHSV(math.sin(t) * 0.1 + 0.6, 0.7, 1)
            task.wait(0.03)
        end
    end)

    local header = Instance.new("Frame")
    header.Size = UDim2.new(1, 0, 0, 60)
    header.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    header.BorderSizePixel = 0
    header.Parent = mainFrame
    Instance.new("UICorner", header).CornerRadius = UDim.new(0, 15)

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -60, 1, 0)
    title.Position = UDim2.new(0, 20, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "PROXIMITY HUB"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 22
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = header

    local searchBox = Instance.new("TextBox")
    searchBox.Size = UDim2.new(1, -40, 0, 35)
    searchBox.Position = UDim2.new(0, 20, 0, 75)
    searchBox.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    searchBox.Text = ""
    searchBox.PlaceholderText = "üîç Rechercher..."
    searchBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    searchBox.Font = Enum.Font.Gotham
    searchBox.TextSize = 14
    searchBox.Parent = mainFrame
    Instance.new("UICorner", searchBox).CornerRadius = UDim.new(0, 8)

    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Size = UDim2.new(1, -30, 1, -140)
    scrollFrame.Position = UDim2.new(0, 15, 0, 120)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.ScrollBarThickness = 2
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(80, 80, 255)
    scrollFrame.Parent = mainFrame
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 10)
    listLayout.SortOrder = Enum.SortOrder.Name
    listLayout.Parent = scrollFrame

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 35, 0, 35)
    closeBtn.Position = UDim2.new(1, -45, 0, 12)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
    closeBtn.Text = "√ó"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 20
    closeBtn.Parent = header
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(1, 0)
    closeBtn.MouseButton1Click:Connect(function() screenGui:Destroy() end)

    searchBox:GetPropertyChangedSignal("Text"):Connect(function()
        local filter = searchBox.Text:lower()
        for model, button in pairs(activeButtons) do
            button.Visible = model.Name:lower():find(filter) ~= nil
        end
    end)

    return mainFrame, scrollFrame, listLayout
end

local function findProximityPrompt(model)
    for _, descendant in ipairs(model:GetDescendants()) do
        if descendant:IsA("ProximityPrompt") then return descendant end
    end
end

local function findTeleportPosition(model)
    local part = model:FindFirstChild("HumanoidRootPart") or model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart", true)
    return part and part.CFrame + Vector3.new(0, 3, 0)
end

local function createCharacterButton(characterModel, parent)
    local button = Instance.new("TextButton")
    button.Name = characterModel.Name
    button.Size = UDim2.new(1, -5, 0, 50)
    button.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
    button.Text = ""
    button.AutoButtonColor = false
    button.Parent = parent
    
    local corner = Instance.new("UICorner", button)
    corner.CornerRadius = UDim.new(0, 10)
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -20, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = "üë§ " .. characterModel.Name
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.Font = Enum.Font.GothamSemibold
    label.TextSize = 15
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = button

    rippleEffect(button)

    button.MouseButton1Click:Connect(function()
        local char = player.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        local prompt = findProximityPrompt(characterModel)
        local pos = findTeleportPosition(characterModel)

        if hrp and prompt and pos then
            local oldCFrame = hrp.CFrame
            label.Text = "‚è≥ ..."
            hrp.CFrame = pos
            task.wait(0.15)
            fireproximityprompt(prompt)
            task.wait(0.1)
            hrp.CFrame = oldCFrame
            label.Text = "‚úÖ OK"
            task.wait(1)
            label.Text = "üë§ " .. characterModel.Name
        end
    end)
    
    return button
end

local function main()
    local mainFrame, scrollFrame, listLayout = createUI()
    
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 5)
    end)

    task.spawn(function()
        while mainFrame.Parent do
            local folder = workspace:FindFirstChild("Essentials") and workspace.Essentials:FindFirstChild("Characters")
            if folder then
                local currentModels = folder:GetChildren()
                local modelMap = {}

                for _, model in ipairs(currentModels) do
                    if model:IsA("Model") and findProximityPrompt(model) then
                        modelMap[model] = true
                        if not activeButtons[model] then
                            activeButtons[model] = createCharacterButton(model, scrollFrame)
                        end
                    end
                end

                for model, button in pairs(activeButtons) do
                    if not modelMap[model] or not model.Parent then
                        button:Destroy()
                        activeButtons[model] = nil
                    end
                end
            end
            task.wait(1)
        end
    end)
end

main()

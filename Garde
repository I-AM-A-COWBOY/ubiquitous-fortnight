local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Table pour garder une trace des boutons cr√©√©s (Model -> Button)
local activeButtons = {}

local function createUI()
    if playerGui:FindFirstChild("ProximityClickerUI") then
        playerGui:FindFirstChild("ProximityClickerUI"):Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ProximityClickerUI"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = playerGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 350, 0, 450)
    mainFrame.Position = UDim2.new(0.5, -175, 0.5, -225)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    mainFrame.BorderSizePixel = 0
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 12)
    mainCorner.Parent = mainFrame
    
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = Color3.fromRGB(100, 100, 255)
    mainStroke.Thickness = 2
    mainStroke.Parent = mainFrame
    
    task.spawn(function()
        while mainFrame.Parent do
            for i = 100, 200, 5 do
                if not mainFrame.Parent then break end
                mainStroke.Color = Color3.fromRGB(i, i, 255)
                task.wait(0.05)
            end
            for i = 200, 100, -5 do
                if not mainFrame.Parent then break end
                mainStroke.Color = Color3.fromRGB(i, i, 255)
                task.wait(0.05)
            end
        end
    end)
    
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 50)
    header.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
    header.BorderSizePixel = 0
    header.Parent = mainFrame
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 12)
    headerCorner.Parent = header
    
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -100, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "üëÜ Proximity Clicker"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 20
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = header
    
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 40, 0, 40)
    closeButton.Position = UDim2.new(1, -45, 0, 5)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    closeButton.Text = "‚úï"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 20
    closeButton.Font = Enum.Font.GothamBold
    closeButton.BorderSizePixel = 0
    closeButton.Parent = header
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = closeButton
    
    local closeStroke = Instance.new("UIStroke")
    closeStroke.Color = Color3.fromRGB(200, 0, 0)
    closeStroke.Thickness = 1
    closeStroke.Parent = closeButton
    
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)
    
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "CharacterList"
    scrollFrame.Size = UDim2.new(1, -20, 1, -70)
    scrollFrame.Position = UDim2.new(0, 10, 0, 60)
    scrollFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 6
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 255)
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrollFrame.Parent = mainFrame
    
    local scrollCorner = Instance.new("UICorner")
    scrollCorner.CornerRadius = UDim.new(0, 8)
    scrollCorner.Parent = scrollFrame
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 8)
    listLayout.SortOrder = Enum.SortOrder.Name
    listLayout.Parent = scrollFrame
    
    return mainFrame, scrollFrame, listLayout
end

local function findProximityPrompt(model)
    for _, descendant in ipairs(model:GetDescendants()) do
        if descendant:IsA("ProximityPrompt") then
            return descendant
        end
    end
    return nil
end

local function findTeleportPosition(model)
    local hrp = model:FindFirstChild("HumanoidRootPart")
    if hrp then return hrp.CFrame + Vector3.new(0, 3, 0) end
    local primaryPart = model.PrimaryPart
    if primaryPart then return primaryPart.CFrame + Vector3.new(0, 3, 0) end
    for _, child in ipairs(model:GetDescendants()) do
        if child:IsA("BasePart") then return child.CFrame + Vector3.new(0, 3, 0) end
    end
    return nil
end

local function createCharacterButton(characterModel, parent)
    local button = Instance.new("TextButton")
    button.Name = characterModel.Name
    button.Size = UDim2.new(1, -10, 0, 40)
    button.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
    button.Text = "üëÜ " .. characterModel.Name
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 14
    button.Font = Enum.Font.Gotham
    button.BorderSizePixel = 0
    button.Parent = parent
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = button
    
    local buttonStroke = Instance.new("UIStroke")
    buttonStroke.Color = Color3.fromRGB(70, 70, 200)
    buttonStroke.Thickness = 2
    buttonStroke.Parent = button
    
    button.MouseButton1Click:Connect(function()
        local char = player.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        local originalPos = hrp.CFrame
        local prompt = findProximityPrompt(characterModel)
        local telePos = findTeleportPosition(characterModel)
        
        if not prompt or not telePos then 
            button.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
            button.Text = "‚ùå Erreur"
            task.wait(1)
            if button.Parent then
                button.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
                button.Text = "üëÜ " .. characterModel.Name
            end
            return 
        end
        
        button.Text = "‚è≥ Action..."
        hrp.CFrame = telePos
        task.wait(0.2)
        fireproximityprompt(prompt)
        task.wait(0.2)
        hrp.CFrame = originalPos
        button.Text = "‚úÖ Fait!"
        task.wait(0.5)
        if button.Parent then button.Text = "üëÜ " .. characterModel.Name end
    end)
    
    return button
end

local function main()
    local mainFrame, scrollFrame, listLayout = createUI()
    
    -- Connexion automatique du CanvasSize
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
    end)

    -- Boucle de mise √† jour en temps r√©el
    task.spawn(function()
        while mainFrame.Parent do
            local charactersFolder = game.Workspace:FindFirstChild("Essentials") and game.Workspace.Essentials:FindFirstChild("Characters")
            
            if charactersFolder then
                local currentChildren = charactersFolder:GetChildren()
                local modelList = {}

                -- Ajouter les nouveaux mod√®les
                for _, child in ipairs(currentChildren) do
                    if child:IsA("Model") and findProximityPrompt(child) then
                        modelList[child] = true
                        if not activeButtons[child] then
                            activeButtons[child] = createCharacterButton(child, scrollFrame)
                        end
                    end
                end

                -- Supprimer les mod√®les qui n'existent plus
                for model, button in pairs(activeButtons) do
                    if not modelList[model] or not model.Parent then
                        button:Destroy()
                        activeButtons[model] = nil
                    end
                end
            end
            task.wait(1) -- Fr√©quence de rafra√Æchissement (1 seconde)
        end
    end)
end

main()
